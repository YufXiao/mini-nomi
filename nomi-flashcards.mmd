flowchart TD
    %% --- 样式定义 ---
    classDef startend fill:#fff,stroke:#333,stroke-width:2px,color:#000;
    classDef phase fill:#0F172A,stroke:#38BDF8,stroke-width:2px,color:#fff;
    classDef action fill:#1E293B,stroke:#94A3B8,stroke-width:1px,color:#fff;
    classDef decision fill:#0F172A,stroke:#32D74B,stroke-width:1px,color:#fff,stroke-dasharray: 5 5;
    classDef system fill:#334155,stroke:#none,color:#fff;

    %% --- 节点定义 ---
    Start((启动应用)):::startend
    
    %% 阶段 0: 首页
    subgraph HomePhase [阶段 0: 首页]
        DisplayHome[展示首页 标题/开始按钮/设置]:::phase
        ClickSettings([点击设置]):::action
        ShowSettingsAlert[弹出设置提示]:::system
        ClickStart([点击 START RUN]):::action
    end

    %% 阶段 1: 记忆阶段
    subgraph MemoPhase [阶段 1: 记忆阶段]
        InitList[加载单词列表 启动 15s 倒计时]:::system
        DisplayList[展示单词 & 音节拆分]:::phase
        WaitTimeout{倒计时结束?}:::decision
        ClickReady([点击 I'M READY]):::action
    end

    %% 阶段 2: 战斗阶段
    subgraph CombatPhase [阶段 2: 气泡战斗阶段]
        LoadLevel[加载当前关卡数据 中文释义 + 空槽位 + 漂浮气泡]:::system
        DisplayCombat[展示战斗界面]:::phase
        
        %% 用户操作分支
        subgraph Interaction [用户交互]
            ClickSkip([点击 SKIP ⏭]):::action
            ClickBubble([点击气泡]):::action
        end
        
        FillSlot[气泡飞入槽位 槽位变实心]:::system
        CheckFull{槽位已满?}:::decision
        
        %% 判定逻辑
        Validate{答案正确?}:::decision
        
        %% 结果反馈
        FeedbackSuccess[显示胜利动效 文字高亮]:::system
        FeedbackError[震动反馈 Shake 槽位变红]:::system
        ResetLevel[重置当前关卡 清空槽位/气泡回池]:::system
        
        %% 关卡流转
        NextLevel{还有下一关?}:::decision
    end

    RunComplete((流程结束)):::startend

    %% --- 连线逻辑 ---

    %% 启动与首页
    Start --> DisplayHome
    DisplayHome --> ClickSettings --> ShowSettingsAlert --> DisplayHome
    DisplayHome --> ClickStart
    
    %% 首页 -> 记忆
    ClickStart --> InitList --> DisplayList
    
    %% 记忆 -> 战斗 (两种触发方式)
    DisplayList --> WaitTimeout
    DisplayList --> ClickReady
    WaitTimeout -- 是 --> LoadLevel
    WaitTimeout -- 否 --> DisplayList
    ClickReady --> LoadLevel

    %% 战斗循环
    LoadLevel --> DisplayCombat
    
    %% 分支 1: 跳过
    DisplayCombat --> ClickSkip
    ClickSkip --> NextLevel

    %% 分支 2: 拼写
    DisplayCombat --> ClickBubble --> FillSlot
    FillSlot --> CheckFull
    CheckFull -- 否 --> DisplayCombat
    CheckFull -- 是 --> Validate

    %% 验证结果
    Validate -- 正确 (Success) --> FeedbackSuccess
    FeedbackSuccess --> NextLevel
    
    Validate -- 错误 (Fail) --> FeedbackError
    FeedbackError --> ResetLevel --> DisplayCombat

    %% 关卡跳转
    NextLevel -- 是 --> LoadLevel
    NextLevel -- 否 (全部完成) --> RunComplete
    RunComplete --> DisplayHome